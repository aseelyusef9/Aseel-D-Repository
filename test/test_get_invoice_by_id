import unittest
from fastapi.testclient import TestClient
from db_util import init_db, get_db


class TestGetInvoiceById(unittest.TestCase):

    def setUp(self):
        """
        Runs before each test
        """
        init_db()

        # Insert test data
        with get_db() as conn:
            cursor = conn.cursor()

            # Insert invoice
            cursor.execute("""
                INSERT INTO invoices (
                    InvoiceId, VendorName, InvoiceDate,
                    BillingAddressRecipient, ShippingAddress,
                    SubTotal, ShippingCost, InvoiceTotal
                ) VALUES (?, ?, ?, ?, ?, ?, ?, ?)
            """, (
                "INV-TEST-001",
                "SuperStore",
                "2012-03-06T00:00:00+00:00",
                "Aaron Bergman",
                "98103, Seattle, Washington, United States",
                53.82,
                4.29,
                58.11
            ))

            # Insert items
            cursor.execute("""
                INSERT INTO items (
                    InvoiceId, Description, Name,
                    Quantity, UnitPrice, Amount
                ) VALUES (?, ?, ?, ?, ?, ?)
            """, (
                "INV-TEST-001",
                "Newell 330 Art, Office Supplies, OFF-AR-5309",
                "Newell 330 Art, Office Supplies, OFF-AR-5309",
                3,
                17.94,
                53.82
            ))

            conn.commit()

        # Import app AFTER DB setup
        from app import app
        self.client = TestClient(app)

    def test_get_invoice_by_id_success(self):
        """
        Test GET /invoice/{invoice_id} when invoice exists
        """
        response = self.client.get("/invoice/INV-TEST-001")

        self.assertEqual(response.status_code, 200)

        result = response.json()

        expected_response = {
            "InvoiceId": "INV-TEST-001",
            "VendorName": "SuperStore",
            "InvoiceDate": "2012-03-06T00:00:00+00:00",
            "BillingAddressRecipient": "Aaron Bergman",
            "ShippingAddress": "98103, Seattle, Washington, United States",
            "SubTotal": 53.82,
            "ShippingCost": 4.29,
            "InvoiceTotal": 58.11,
            "Items": [
                {
                    "Description": "Newell 330 Art, Office Supplies, OFF-AR-5309",
                    "Name": "Newell 330 Art, Office Supplies, OFF-AR-5309",
                    "Quantity": 3,
                    "UnitPrice": 17.94,
                    "Amount": 53.82
                }
            ]
        }

        self.assertEqual(result, expected_response)

        print("✓ GET /invoice/{invoice_id} test passed")

    def test_get_invoice_by_id_not_found(self):
        """
        Test GET /invoice/{invoice_id} when invoice does NOT exist
        """
        response = self.client.get("/invoice/INV-NOT-EXIST")

        self.assertEqual(response.status_code, 404)
        self.assertEqual(response.json()["detail"], "Invoice not found")

        print("✓ Invoice not found test passed")


if __name__ == "__main__":
    unittest.main()
