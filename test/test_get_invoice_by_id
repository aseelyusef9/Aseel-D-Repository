# test/test_invoice_endpoint.py
import unittest
from fastapi.testclient import TestClient
from db_util import init_db, clean_db, get_db
from app import app

class TestGetInvoiceById(unittest.TestCase):
    """Integration test for GET /invoice/{invoice_id}"""

    def setUp(self):
        """Set up test database and insert test invoice"""
        init_db()
        with get_db() as conn:
            cursor = conn.cursor()

            # Insert invoice 36259
            cursor.execute("""
                INSERT INTO invoices (
                    InvoiceId, VendorName, InvoiceDate, BillingAddressRecipient,
                    ShippingAddress, SubTotal, ShippingCost, InvoiceTotal
                ) VALUES (?, ?, ?, ?, ?, ?, ?, ?)
            """, (
                "36259",
                "SuperStore",
                "Mar 06 2012",
                "Aaron Bergman",
                "98103, Seattle, Washington, United States",
                "$53.82",
                "$4.29",
                "$58.11"
            ))

            # Insert items for the invoice
            items = [
                ("36259", "Item 1 Description", "Item 1", 1, 30.0, 30.0),
                ("36259", "Item 2 Description", "Item 2", 1, 23.82, 23.82),
            ]
            cursor.executemany("""
                INSERT INTO items (InvoiceId, Description, Name, Quantity, UnitPrice, Amount)
                VALUES (?, ?, ?, ?, ?, ?)
            """, items)
            conn.commit()

    def tearDown(self):
        """Clean the database after each test"""
        clean_db()

    def test_get_invoice_success(self):
        """GET /invoice/36259 returns correct invoice"""
        client = TestClient(app)
        response = client.get("/invoice/36259")

        # Check HTTP status
        self.assertEqual(response.status_code, 200)

        result = response.json()

        # Check main invoice fields
        self.assertEqual(result["InvoiceId"], "36259")
        self.assertEqual(result["VendorName"], "SuperStore")
        self.assertEqual(result["InvoiceDate"], "Mar 06 2012")
        self.assertEqual(result["BillingAddressRecipient"], "Aaron Bergman")
        self.assertEqual(result["ShippingAddress"], "98103, Seattle, Washington, United States")
        self.assertEqual(result["SubTotal"], "$53.82")
        self.assertEqual(result["ShippingCost"], "$4.29")
        self.assertEqual(result["InvoiceTotal"], "$58.11")

        # Check items
        self.assertEqual(len(result["Items"]), 2)

        self.assertEqual(result["Items"][0]["Description"], "Item 1 Description")
        self.assertEqual(result["Items"][0]["Name"], "Item 1")
        self.assertEqual(result["Items"][0]["Quantity"], 1)
        self.assertEqual(result["Items"][0]["UnitPrice"], 30.0)
        self.assertEqual(result["Items"][0]["Amount"], 30.0)

        self.assertEqual(result["Items"][1]["Description"], "Item 2 Description")
        self.assertEqual(result["Items"][1]["Name"], "Item 2")
        self.assertEqual(result["Items"][1]["Quantity"], 1)
        self.assertEqual(result["Items"][1]["UnitPrice"], 23.82)
        self.assertEqual(result["Items"][1]["Amount"], 23.82)

    def test_get_invoice_not_found(self):
        """GET /invoice/{invoice_id} returns 404 for non-existent invoice"""
        client = TestClient(app)
        response = client.get("/invoice/99999")  # invoice ID that doesn't exist

        # Expect 404 Not Found
        self.assertEqual(response.status_code, 404)

        result = response.json()
        self.assertEqual(result["detail"], "Invoice not found")

if __name__ == "__main__":
    unittest.main()
